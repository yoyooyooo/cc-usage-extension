# 浏览器插件开发技术规格书

## 项目概述

开发一个浏览器插件，用于快速查询用户自定义 API，并将响应的数据渲染为 4 张信息卡片，显示如下字段：

- 月度预算
- 本月已花费
- 日度预算
- 今日已花费

## 技术选型

- 框架：WXT (基于 Vite)
- 编程语言：TypeScript
- 前端框架：React + Tailwind CSS
- 接口请求：Fetch API
- 存储方案：`chrome.storage.sync`
- UI 组件库：shadcn/ui

## 插件结构（实际实现）

```
cc-usage/
├─ entrypoints/
│  ├─ popup/
│  │  ├─ App.tsx          # 主应用组件
│  │  ├─ App.css          # 样式文件
│  │  ├─ index.html       # Popup 入口页面
│  │  ├─ main.tsx         # React 入口
│  │  └─ style.css        # 全局样式
│  ├─ options/            # Options 页面（规划中）
│  ├─ background.ts       # 后台脚本
│  └─ content.ts          # 内容脚本
├─ components/
│  ├─ ui/                 # shadcn/ui 基础组件
│  │  ├─ button.tsx
│  │  ├─ card.tsx
│  │  ├─ input.tsx
│  │  ├─ label.tsx
│  │  ├─ select.tsx
│  │  ├─ slider.tsx       # 双滑块组件
│  │  └─ textarea.tsx
│  ├─ CircularProgress.tsx # 圆形进度指示器
│  ├─ CountdownTimer.tsx  # 当天剩余时间倒计时组件
│  ├─ DataCard.tsx        # 数据卡片组件
│  ├─ DataGrid.tsx        # 数据网格布局
│  ├─ RemainingBudgetAlert.tsx # 剩余预算智能警示组件
│  └─ SettingsView.tsx    # 设置页面组件
├─ types/                 # TypeScript 类型定义
│  └─ index.ts
├─ utils/                 # 工具函数
│  ├─ api.ts             # API 相关函数
│  ├─ storage.ts         # 存储相关函数
│  ├─ fieldMatcher.ts    # 智能字段匹配引擎
│  └─ workingTime.ts     # 工作时间处理工具
├─ lib/
│  └─ utils.ts           # 通用工具函数
├─ public/               # 静态资源
│  ├─ icon/              # 插件图标
│  └─ wxt.svg
├─ wxt.config.ts         # WXT 配置
├─ tailwind.config.ts    # Tailwind CSS 配置
├─ components.json       # shadcn/ui 配置
├─ tsconfig.json         # TypeScript 配置
└─ package.json          # 依赖管理
```

## 插件设置项

### 基本配置

- API URL（必填）
- API Token（必填，password 类型输入）

### 工作时间配置

- 工作时间区间：使用双滑块选择工作开始和结束时间（默认 09:00-24:00）
- 消费速率计算基于工作时间，避免将休息时间计入
- 支持实时预览时间区间设置

### 字段映射配置 - 智能匹配

插件支持智能字段匹配，自动识别 API 响应中的预算和花费字段：

| 槽位          | 描述示例   | 智能匹配规则 | 手动选择 |
| ------------- | ---------- | ------------ | -------- |
| monthlyBudget | 月度预算   | month+budget 关键词组合 | 响应字段 key |
| monthlySpent  | 本月已花费 | month+spent/used 关键词组合 | 响应字段 key |
| dailyBudget   | 日度预算   | daily+budget 关键词组合 | 响应字段 key |
| dailySpent    | 今日已花费 | daily+spent/used 关键词组合 | 响应字段 key |

**智能匹配特性：**
- 支持多种命名风格：驼峰命名、下划线命名、短横线命名
- 关键词匹配：如 monthlyBudget、monthly_budget、month-budget 等
- 置信度评估：显示匹配置信度百分比和匹配原因
- 视觉反馈：自动匹配字段显示蓝色边框和 ✨ 图标
- 手动调整：用户可随时调整自动匹配结果

### 用户交互过程

1. 用户填写 API URL 和 Token。
2. 配置工作时间区间（可选，默认 09:00-24:00）。
3. 点击"测试连接"，插件请求 API 并自动运行智能字段匹配。
4. 系统显示匹配结果：自动匹配字段显示置信度和匹配原因。
5. 用户可手动调整字段映射或点击"重新匹配"。
6. 点击"保存"完成配置。

## 存储的数据模型

```typescript
interface PluginSettings {
  apiUrl: string;
  token: string;
  workingHours: {
    start: number;  // 工作开始时间（24 小时制）
    end: number;    // 工作结束时间（24 小时制）
  };
  mapping: {
    monthlyBudget: string;
    monthlySpent: string;
    dailyBudget: string;
    dailySpent: string;
  };
}
```

**数据模型更新说明：**
- 新增 `workingHours` 字段：支持自定义工作时间区间
- 向后兼容：自动为旧配置补充默认工作时间（09:00-24:00）
- 工作时间影响消费速率计算和警示状态判断

## 插件运行时逻辑

1. 从 `chrome.storage.sync` 加载配置。
2. 发起 API 请求（60 秒缓存，避免频繁调用）。
3. 根据映射路径解析 JSON 响应。
4. 渲染为 4 张信息卡片。
5. **智能警示计算**：
   - 基于工作时间计算当前和剩余消费速率
   - 根据预算使用率和工作状态显示不同级别警示
   - 实时更新警示状态和颜色提示

## UI 组件

### Popup 页面（已实现 - 现代化深色主题）

**界面特色：**
- 采用深色主题设计 (`bg-gray-900`)，现代优雅
- 中央圆形进度指示器显示使用百分比
- 动态颜色状态：绿色(安全) / 琥珀色(警告) / 红色(超限)

**布局结构：**
1. **头部导航栏**：标题 + 刷新按钮 + 设置按钮
2. **中央进度环**：显示当日开销使用率百分比，包含状态指示器
3. **当天剩余时间倒计时**：显示距离当天结束的实时倒计时（HH:MM:SS格式）
4. **智能预算警示**：基于工作时间的消费速率警示组件
   - 6 种警示级别：工作前/工作后/超限/危险/警告/谨慎/正常/保守
   - 显示每小时必需消费速率和预测剩余预算
   - 动态颜色和图标提示
5. **底部功能卡片**：
   - 每日开销卡片：显示今日已花费、预算和使用率百分比
   - 月度开销卡片：显示本月已花费、预算和使用率百分比

**交互效果：**
- hover 悬浮缩放效果
- 平滑的过渡动画  
- 状态指示器呼吸灯效果
- 实时倒计时每秒更新
- 卡片使用率百分比动态颜色变化（绿色/黄色/红色）

### Options 页面（已实现 - 深色主题适配）

**界面特色：**
- 与 Popup 页面统一的深色主题
- 卡片式布局，层次分明
- 响应式表单设计

**功能模块：**
1. **API 连接配置卡片**：
   - API URL 输入框
   - Token 输入框（password 类型，支持显示/隐藏切换）
   - 测试连接按钮（带加载状态）
2. **工作时间配置卡片**：
   - 双滑块时间选择器（基于 Radix UI）
   - 实时预览工作时间区间
   - 工作时间说明和使用提示
3. **字段映射配置卡片 - 智能匹配增强**：
   - 智能字段匹配引擎：自动识别预算和花费字段
   - 置信度评估：显示匹配置信度百分比
   - 视觉反馈：自动匹配字段蓝色边框 + ✨ 图标
   - 匹配原因显示：关键词匹配逻辑说明
   - 重新匹配按钮：手动触发重新智能匹配
   - 四个字段映射下拉选择框（支持手动调整）
   - 实时字段选项更新
4. **保存操作**：
   - 保存配置按钮（带加载状态）
   - Toast 提示反馈

## 安全性和性能考虑

- Token 使用 password 类型输入框，禁止明文回填。
- 配置页面的 API 请求由用户手动触发。
- Popup 页面数据结果缓存 60 秒，降低 API 负载。

## 依赖管理（已实现）

**核心依赖：**
- `wxt`: 现代 Web 扩展开发框架
- `react` + `react-dom`: UI 框架
- `typescript`: 类型安全
- `tailwindcss`: CSS 工具库
- `lucide-react`: 图标库

**UI 组件：**
- `shadcn/ui`: 现代 UI 组件库
- `react-hot-toast`: 消息提示
- `@radix-ui/*`: 无头组件基础
- `@radix-ui/react-slider`: 双滑块时间选择器

**开发工具：**
- `vite`: 构建工具
- `@types/*`: TypeScript 类型定义
- `autoprefixer`: CSS 后处理
- `postcss`: CSS 处理工具

## 版本规划

| 版本 | 功能                                             | 状态 |
| ---- | ------------------------------------------------ | ---- |
| v0.1 | 基础项目搭建 + Popup UI                          | ✅ 已完成 |
| v0.2 | 增加设置页支持配置 URL 和 Token                   | ✅ 已完成 |
| v0.3 | 字段映射下拉菜单选择                             | ✅ 已完成 |
| v0.4 | 现代化 UI 设计（深色主题 + 圆形进度指示器）        | ✅ 已完成 |
| v0.5 | 优化 UI 布局（当日开销圆环 + 实时倒计时 + 卡片重设计） | ✅ 已完成 |
| v0.6 | 智能预算警示（工作时间 + 消费速率 + 6级警示）      | ✅ 已完成 |
| v0.7 | 智能字段匹配（自动识别 + 置信度评估 + 视觉反馈）    | ✅ 已完成 |
| v1.0 | 完善用户体验（国际化、主题切换、数据导出）         | 📋 规划中 |

## 后续扩展

- 支持字段映射的导入导出功能
- 国际化支持
- 多套 UI 主题切换
- 更多数据可视化图表
- 使用趋势分析
- 自定义警示阈值设置
- 多 API 源支持和数据聚合
- 消费预测和预算建议算法

## 开发进度追踪

- [x] 创建基础项目并完成 Popup UI
- [x] 实现设置页的 API 测试功能
- [x] 实现字段映射下拉选择功能
- [x] 完善运行时逻辑，完成缓存策略
- [x] 实现现代化深色主题 UI 设计
- [x] 添加圆形进度指示器和动画效果
- [x] 优化 UI 布局：圆环显示当日开销 + 实时倒计时 + 重新设计卡片
- [x] 实现工作时间配置功能（双滑块选择器）
- [x] 开发智能预算警示系统（6级警示 + 消费速率计算）
- [x] 构建智能字段匹配引擎（自动识别 + 置信度评估）
- [x] 完善设置页面智能匹配功能（视觉反馈 + 重新匹配）
- [ ] 添加 Options 独立页面支持
- [ ] 实现数据导入导出功能
- [ ] 添加多语言国际化支持
- [ ] 添加自定义警示阈值设置
- [ ] 实现消费趋势分析功能
