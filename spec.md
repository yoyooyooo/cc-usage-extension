# 浏览器插件开发技术规格书

## 项目概述

开发一个浏览器插件，用于快速查询用户自定义 API，并将响应的数据渲染为 4 张信息卡片，显示如下字段：

- 月度预算
- 本月已花费
- 日度预算
- 今日已花费

## 技术选型

- 框架：WXT (基于 Vite)
- 编程语言：TypeScript
- 前端框架：React + Tailwind CSS
- 接口请求：Fetch API
- 存储方案：`chrome.storage.sync`
- 状态管理：Zustand（v1.2.1 新增）
- UI 组件库：shadcn/ui

## 插件结构（实际实现）

```
cc-usage/
├─ entrypoints/
│  ├─ popup/
│  │  ├─ App.tsx          # 主应用组件
│  │  ├─ App.css          # 样式文件
│  │  ├─ index.html       # Popup 入口页面
│  │  ├─ main.tsx         # React 入口
│  │  └─ style.css        # 全局样式
│  ├─ options/            # Options 页面（规划中）
│  ├─ background.ts       # 后台脚本
│  └─ content.ts          # 内容脚本
├─ components/
│  ├─ ui/                 # shadcn/ui 基础组件
│  │  ├─ button.tsx
│  │  ├─ card.tsx
│  │  ├─ input.tsx
│  │  ├─ label.tsx
│  │  ├─ select.tsx
│  │  ├─ slider.tsx       # 双滑块组件
│  │  ├─ switch.tsx       # 开关组件
│  │  └─ textarea.tsx
│  ├─ CircularProgress.tsx # 圆形进度指示器
│  ├─ CountdownTimer.tsx  # 当天剩余时间倒计时组件
│  ├─ DataCard.tsx        # 数据卡片组件
│  ├─ DataGrid.tsx        # 数据网格布局
│  ├─ RemainingBudgetAlert.tsx # 剩余预算智能警示组件
│  ├─ SettingsView.tsx    # 设置页面组件
│  ├─ UsageChart.tsx      # 使用趋势图表组件（v1.2.0 新增）
│  ├─ DailyTimelineChart.tsx # 24小时时间线图表（v1.2.0 新增）
│  ├─ DailyTimelineChartWithRate.tsx # 带消费速率的时间线图表（v1.2.3 新增）
│  ├─ ChartErrorBoundary.tsx # 图表错误边界组件（v1.2.3 新增）
│  └─ RateFeatureToggle.tsx # 速率功能开关组件（v1.2.3 新增）
├─ stores/                # Zustand 状态管理（v1.2.1 新增）
│  └─ settingsStore.ts    # 统一设置状态管理
├─ types/                 # TypeScript 类型定义
│  └─ index.ts
├─ utils/                 # 工具函数
│  ├─ api.ts             # API 相关函数
│  ├─ storage.ts         # 存储相关函数（历史数据、缓存、通知）
│  ├─ fieldMatcher.ts    # 智能字段匹配引擎
│  ├─ workingTime.ts     # 工作时间处理工具
│  └─ dataManagement.ts  # 数据导入导出管理（v1.2.3 新增）
├─ lib/
│  └─ utils.ts           # 通用工具函数
├─ public/               # 静态资源
│  ├─ icon/              # 插件图标
│  └─ wxt.svg
├─ wxt.config.ts         # WXT 配置
├─ tailwind.config.ts    # Tailwind CSS 配置
├─ components.json       # shadcn/ui 配置
├─ tsconfig.json         # TypeScript 配置
└─ package.json          # 依赖管理
```

## 插件设置项

### 基本配置

- API URL（必填）
- API Token（必填，password 类型输入）

### 工作时间配置

- 工作时间区间：使用双滑块选择工作开始和结束时间（默认 09:00-24:00）
- 消费速率计算基于工作时间，避免将休息时间计入
- 支持实时预览时间区间设置

### 智能通知配置（v1.1.0 新增）

- **通知开关**：启用/禁用智能通知功能
- **查询间隔**：1-60分钟可调（默认5分钟）
- **日度预算警告阈值**：50%-95%可调（默认80%）
- **月度预算警告阈值**：50%-95%可调（默认90%）

**通知特性：**
- 后台定时查询：使用 Chrome Alarms API 实现定时任务
- 智能去重：30分钟内不重复发送同类型通知
- 自动重置：每日/月度开始时重置通知状态
- 桌面通知：使用 Chrome Notifications API 发送系统通知

### 字段映射配置 - 智能匹配

插件支持智能字段匹配，自动识别 API 响应中的预算和花费字段：

| 槽位          | 描述示例   | 智能匹配规则 | 手动选择 |
| ------------- | ---------- | ------------ | -------- |
| monthlyBudget | 月度预算   | month+budget 关键词组合 | 响应字段 key |
| monthlySpent  | 本月已花费 | month+spent/used 关键词组合 | 响应字段 key |
| dailyBudget   | 日度预算   | daily+budget 关键词组合 | 响应字段 key |
| dailySpent    | 今日已花费 | daily+spent/used 关键词组合 | 响应字段 key |

**智能匹配特性：**
- 支持多种命名风格：驼峰命名、下划线命名、短横线命名
- 关键词匹配：如 monthlyBudget、monthly_budget、month-budget 等
- 置信度评估：显示匹配置信度百分比和匹配原因
- 视觉反馈：自动匹配字段显示蓝色边框和 ✨ 图标
- 手动调整：用户可随时调整自动匹配结果

### 警示阈值配置（v1.2.0 新增）

插件支持自定义预算警示级别的触发阈值：

**可配置阈值：**
- **危险阈值**：1.3x-2.0x 可调（默认1.5x）
- **警告阈值**：1.1x-1.5x 可调（默认1.2x）
- **谨慎阈值**：0.9x-1.2x 可调（默认1.0x）
- **正常范围下限**：0.5x-0.9x 可调（默认0.8x）

**阈值特性：**
- 实时生效：调整阈值后立即影响警示级别判断
- 视觉反馈：每个阈值配有对应颜色的圆点指示器
- 智能提示：显示每个阈值的作用说明
- 速率计算：基于当前消费速率与建议速率的比值

### 用户交互过程

1. 用户填写 API URL 和 Token。
2. 配置工作时间区间（可选，默认 09:00-24:00）。
3. 点击"测试连接"，插件请求 API 并自动运行智能字段匹配。
4. 系统显示匹配结果：自动匹配字段显示置信度和匹配原因。
5. 用户可手动调整字段映射或点击"重新匹配"。
6. 点击"保存"完成配置。

## 存储的数据模型

```typescript
interface PluginSettings {
  apiUrl: string;
  token: string;
  workingHours: {
    start: number;  // 工作开始时间（24 小时制）
    end: number;    // 工作结束时间（24 小时制）
  };
  mapping: {
    monthlyBudget: string;
    monthlySpent: string;
    dailyBudget: string;
    dailySpent: string;
  };
  notifications: {  // v1.1.0 新增
    enabled: boolean;
    queryInterval: number;  // 分钟
    thresholds: {
      dailyBudget: number;   // 百分比
      monthlyBudget: number; // 百分比
    };
  };
  alertThresholds?: {  // v1.2.0 新增
    danger: number;      // 危险阈值，默认1.5
    warning: number;     // 警告阈值，默认1.2
    caution: number;     // 谨慎阈值，默认1.0
    normalMin: number;   // 正常范围最小值，默认0.8
  };
}

// 历史数据相关类型（v1.2.0 新增）
interface HistoricalDataPoint {
  timestamp: number;
  dailyBudget: number;
  dailySpent: number;
  monthlyBudget: number;
  monthlySpent: number;
}

interface HistoricalData {
  data: HistoricalDataPoint[];
  lastUpdated: number;
}
```

**数据模型更新说明：**
- 新增 `workingHours` 字段：支持自定义工作时间区间
- 新增 `notifications` 字段：支持智能通知配置（v1.1.0）
- 新增 `alertThresholds` 字段：支持自定义警示阈值（v1.2.0）
- 新增历史数据类型定义：支持数据记录和图表展示（v1.2.0）
- 向后兼容：自动为旧配置补充默认值
- 工作时间影响消费速率计算和警示状态判断
- 历史数据采集：5分钟去重间隔，确保消费速率计算精度（v1.2.3）

## 插件运行时逻辑

### 状态管理架构（v1.2.2 重构）

插件采用 **Zustand 统一状态管理** 架构：

- **Zustand Store** 作为唯一的数据源，管理所有状态
- **组件纯化**：组件专注渲染，不维护本地状态
- **统一数据流**：Components ↔ Store ↔ Chrome Storage
- **自动同步**：状态变更自动持久化
- **智能加载**：配置完整性检查和自动数据加载

**重构优势：**
- 消除了状态同步问题和重复维护
- 简化了组件通信和错误处理
- 提升了代码可维护性和性能
- 实现了真正的单向数据流

### Popup 页面逻辑（v1.2.2 优化）
1. Store 初始化时从 `chrome.storage.sync` 加载配置
2. 检查配置完整性，设置相应错误状态或自动加载数据
3. API 请求使用智能缓存（5分钟）和去重机制，避免频繁调用
4. 根据映射路径解析 JSON 响应
5. 渲染为 4 张信息卡片
6. **智能警示计算**：
   - 基于工作时间计算当前和剩余消费速率
   - 根据预算使用率和工作状态显示不同级别警示
   - 实时更新警示状态和颜色提示
7. **历史数据记录**（v1.2.0 新增，v1.2.3 优化）：
   - 每次刷新时保存当前数据点
   - 自动去重：5分钟内只保留最新数据（提高速率计算精度）
   - 数据清理：保留最近30天的历史记录
   - 每日限制：最多保留288个数据点/天

### 后台脚本逻辑（v1.1.0 新增）
1. 扩展启动时初始化通知监控。
2. 根据用户配置创建定时任务（Chrome Alarms）。
3. 定时执行预算检查：
   - 调用 API 获取最新数据
   - 计算日度/月度使用百分比
   - 与用户设定阈值比较
   - 触发桌面通知（如需要）
4. 智能去重管理：
   - 记录通知发送状态
   - 30分钟内避免重复通知
   - 每日/月度自动重置状态
5. 监听配置变更，动态更新定时任务。

## UI 组件

### Popup 页面（已实现 - 现代化深色主题）

**界面特色：**
- 采用深色主题设计 (`bg-gray-900`)，现代优雅
- 中央圆形进度指示器显示使用百分比
- 动态颜色状态：绿色(安全) / 琥珀色(警告) / 红色(超限)

**布局结构：**
1. **头部导航栏**：标题 + 刷新按钮 + 历史图表按钮 + 设置按钮
2. **中央进度环**：显示当日开销使用率百分比，包含状态指示器
3. **当天剩余时间倒计时**：显示距离当天结束的实时倒计时（HH:MM:SS格式）
4. **智能预算警示**：基于工作时间的消费速率警示组件
   - 8 种警示级别：工作前/工作后/超限/危险/警告/谨慎/正常/保守
   - 显示每小时必需消费速率和预测剩余预算
   - 动态颜色和图标提示
   - 支持自定义阈值（v1.2.0）
5. **底部功能卡片**：
   - 每日开销卡片：显示今日已花费、预算和使用率百分比
   - 月度开销卡片：显示本月已花费、预算和使用率百分比

**交互效果：**
- hover 悬浮缩放效果
- 平滑的过渡动画  
- 状态指示器呼吸灯效果
- 实时倒计时每秒更新
- 卡片使用率百分比动态颜色变化（绿色/黄色/红色）

### Options 页面（已实现 - 深色主题适配）

**界面特色：**
- 与 Popup 页面统一的深色主题
- 卡片式布局，层次分明
- 响应式表单设计

**功能模块：**
1. **API 连接配置卡片**：
   - API URL 输入框
   - Token 输入框（password 类型，支持显示/隐藏切换）
   - 测试连接按钮（带加载状态）
2. **工作时间配置卡片**：
   - 双滑块时间选择器（基于 Radix UI）
   - 实时预览工作时间区间
   - 工作时间说明和使用提示
3. **智能通知配置卡片**（v1.1.0 新增）：
   - 通知开关（Switch 组件）
   - 查询间隔滑块（1-60分钟）
   - 日度预算阈值滑块（50%-95%）
   - 月度预算阈值滑块（50%-95%）
   - 通知说明和使用提示
4. **字段映射配置卡片 - 智能匹配增强**：
   - 智能字段匹配引擎：自动识别预算和花费字段
   - 置信度评估：显示匹配置信度百分比
   - 视觉反馈：自动匹配字段蓝色边框 + ✨ 图标
   - 匹配原因显示：关键词匹配逻辑说明
   - 重新匹配按钮：手动触发重新智能匹配
   - 四个字段映射下拉选择框（支持手动调整）
   - 实时字段选项更新
5. **警示阈值配置卡片**（v1.2.0 新增）：
   - 黄色警告图标标识
   - 四个独立的阈值滑块控件
   - 每个阈值配有颜色圆点指示器
   - 实时显示阈值数值（x倍数）
   - 详细的使用说明和阈值计算公式
6. **保存操作**：
   - 保存配置按钮（带加载状态）
   - Toast 提示反馈

### 历史数据与图表页面（v1.2.0 新增）

**功能特色：**
- 多视图切换：24小时/7天/30天/全部数据
- 两种图表类型：趋势图和24小时时间线
- 数据导出功能：支持CSV格式导出

**趋势图视图：**
- 面积图展示日度/月度使用率趋势
- 支持单独显示或同时显示两种数据
- 统计信息：平均使用率和最高使用率
- 渐变色填充效果

**24小时时间线视图：**
- 柱状图展示每小时的消费情况
- 颜色编码：绿色(正常)/黄色(偏高)/橙色(警告)/红色(超支)
- 日期选择器：可查看历史任意一天的数据
- 统计信息：活跃小时数、平均每小时花费、高峰时段
- 当前时间标记线（仅今天显示）
- **消费速率功能**（v1.2.3 新增）：
  - 可选的消费速率显示开关
  - 双Y轴设计：左侧显示累计花费，右侧显示花费增量
  - 蓝色曲线展示每小时消费增量趋势
  - 增强的Tooltip显示本小时增量和增长率
  - 高增量时段统计卡片
  - 错误边界保护，确保图表稳定性

**数据存储策略：**
- 使用 `chrome.storage.local` 存储（容量更大）
- 自动去重：同一小时内只保留最新数据
- 数据保留：最近30天的历史记录
- 自动清理：超过30天的数据自动删除

## 安全性和性能考虑

- Token 使用 password 类型输入框，禁止明文回填。
- 配置页面的 API 请求由用户手动触发。
- Popup 页面数据结果缓存 5 分钟，降低 API 负载。（v1.2.2 从60秒延长）
- 智能请求去重机制，防止重复调用。（v1.2.2 新增）
- 使用 AbortController 取消无效请求，提升性能。（v1.2.2 新增）
- 图表组件使用错误边界保护，防止渲染错误导致整体崩溃。（v1.2.3 新增）
- 所有数值计算使用安全函数处理，避免 NaN 和 Infinity 错误。（v1.2.3 新增）

## 依赖管理（已实现）

**核心依赖：**
- `wxt`: 现代 Web 扩展开发框架
- `react` + `react-dom`: UI 框架
- `typescript`: 类型安全
- `tailwindcss`: CSS 工具库
- `lucide-react`: 图标库
- `recharts`: 数据可视化图表库（v1.2.0 新增）
- `zustand`: 轻量级状态管理库（v1.2.1 新增）

**UI 组件：**
- `shadcn/ui`: 现代 UI 组件库
- `react-hot-toast`: 消息提示
- `@radix-ui/*`: 无头组件基础
- `@radix-ui/react-slider`: 双滑块时间选择器

**开发工具：**
- `vite`: 构建工具
- `@types/*`: TypeScript 类型定义
- `autoprefixer`: CSS 后处理
- `postcss`: CSS 处理工具

## 版本规划

| 版本 | 功能                                             | 状态 |
| ---- | ------------------------------------------------ | ---- |
| v0.1 | 基础项目搭建 + Popup UI                          | ✅ 已完成 |
| v0.2 | 增加设置页支持配置 URL 和 Token                   | ✅ 已完成 |
| v0.3 | 字段映射下拉菜单选择                             | ✅ 已完成 |
| v0.4 | 现代化 UI 设计（深色主题 + 圆形进度指示器）        | ✅ 已完成 |
| v0.5 | 优化 UI 布局（当日开销圆环 + 实时倒计时 + 卡片重设计） | ✅ 已完成 |
| v0.6 | 智能预算警示（工作时间 + 消费速率 + 6级警示）      | ✅ 已完成 |
| v0.7 | 智能字段匹配（自动识别 + 置信度评估 + 视觉反馈）    | ✅ 已完成 |
| v1.0 | 正式发布版本                                     | ✅ 已完成 |
| v1.1 | 智能通知功能（后台监控 + 阈值警告 + 桌面通知）      | ✅ 已完成 |
| v1.2 | 自定义警示阈值 + 历史数据记录与图表展示             | ✅ 已完成 |
| v1.2.1 | Zustand 状态管理重构（单一数据源 + 数据流优化）     | ✅ 已完成 |
| v1.2.2 | 状态管理完全重构 + 请求优化（去重缓存 + 组件纯化）   | ✅ 已完成 |
| v1.2.3 | 24小时消费速率趋势 + 错误边界保护 + 功能开关设计    | ✅ 已完成 |
| v1.3 | 完善用户体验（国际化、主题切换、数据导出）         | 📋 规划中 |

## 后续扩展

- 支持字段映射的导入导出功能
- 国际化支持
- 多套 UI 主题切换
- 更多数据可视化图表
- 使用趋势分析
- ~~自定义警示阈值设置~~ ✅ v1.2 已完成
- 多 API 源支持和数据聚合
- 消费预测和预算建议算法

## 开发进度追踪

- [x] 创建基础项目并完成 Popup UI
- [x] 实现设置页的 API 测试功能
- [x] 实现字段映射下拉选择功能
- [x] 完善运行时逻辑，完成缓存策略
- [x] 实现现代化深色主题 UI 设计
- [x] 添加圆形进度指示器和动画效果
- [x] 优化 UI 布局：圆环显示当日开销 + 实时倒计时 + 重新设计卡片
- [x] 实现工作时间配置功能（双滑块选择器）
- [x] 开发智能预算警示系统（6级警示 + 消费速率计算）
- [x] 构建智能字段匹配引擎（自动识别 + 置信度评估）
- [x] 完善设置页面智能匹配功能（视觉反馈 + 重新匹配）
- [x] 实现智能通知功能（后台监控 + 定时查询 + 桌面通知）
- [x] 添加自定义警示阈值设置
- [x] 实现历史数据记录和图表展示（recharts）
- [x] 重构状态管理架构（Zustand + 单一数据源）
- [x] 优化数据流和组件通信（移除 ref 复杂度）
- [x] 完全重构状态管理（API数据状态统一 + 组件纯化）
- [x] 实现智能请求优化（去重 + 缓存延长 + AbortController）
- [x] 修复刷新按钮转圈问题（统一loading状态管理）
- [x] 实现24小时消费速率趋势图（双Y轴 + 增量计算）
- [x] 添加图表错误边界保护（防止组件崩溃）
- [x] 实现速率功能开关（渐进增强设计）
- [ ] 添加 Options 独立页面支持
- [ ] 实现数据导入导出功能
- [ ] 添加多语言国际化支持
- [ ] 实现消费趋势分析功能
